<!DOCTYPE html>
<html lang="en">
<head>
    <title>AI TTS - ScamMedia 2000</title>
    <meta charset="UTF-8">
    <script src="lib/twitch.js"></script>

    <script>
        var query = window.location.search.substring(1);    
        let configString = getQueryVariable(query, 'c');
        let config = JSON.parse(atob(configString));
        console.log(config);
        /*
        let config = {
            "channel": "..", // Twitch channel name
            "apiKey": "...", // elevenlabs API Key
            "voice": {
                "bits": {
                    "min": 1,           // min amount for cheer TTS
                    "default": {        // use this AI voice as fallback
                        "id": "....",
                        "similiarity": 0.8,
                        "stability": 0.7,
                        "style": 0.3
                    },   
                    "151": { ... },          // use this AI voice for 151 bit
                    "152": { ... },          // use this AI voice for 152 bit
                }
            }
        }

        btoa(JSON.stringify(config)) // use this as query parameter c for configuration
        */

        const { Chat } = window.TwitchJs;
        var client;
        let channelName = config.channel;
        let queue = [];
        let archive = {};
        let playing = false;
        let index = 0;
        let cheerPrefixes = ["cheer"];
        let cheerPrefixesRegExp = cheerPrefixes.map(x => new RegExp(x + "\\d+", "gi"))

        function textToSpeech(text, voice_id, similarity, stability, style) {;
            let model_id = 'eleven_monolingual_v1';
            return new Promise((resolve, fail) => {
                const options = {
                    method: 'POST',
                    headers: {
                        'Accept': 'audio/mpeg',
                        'Content-Type': 'application/json',
                        'xi-api-key': config.apiKey
                    },
                    body: `{"model_id":"${model_id}","pronunciation_dictionary_locators":[],"text":"${text}","voice_settings":{"similarity_boost":${similarity},"stability":${stability},"style":${style},"use_speaker_boost":true}}`
                };

                fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voice_id}`, options)
                .then(response => response.arrayBuffer())
                .then(audioData => resolve(audioData))
                .catch(fail);
            });
        }

        function playAudio(src, startCB, endCB, minDuration, volume) {
            !src && (startCB() & endCB());
            const audio = new Audio(src)
            audio.volume = volume || 1.0

            audio.onloadedmetadata = () => {
                const duration = audio.duration;
                startCB && startCB();
                audio.play();
                endCB && setTimeout(endCB, Math.max(duration * 1000, minDuration || 0));
            };
        }

        function playTTS(msg, voice, similarity, stability, style, startCB, endCB, minDuration, volume) {
            textToSpeech(msg, voice, similarity, stability, style).then(audioContent => {
                let src = URL.createObjectURL(new Blob([audioContent], { type: 'audio/mpeg' }));
                playAudio(src, startCB, endCB, minDuration, volume)
            });
        }

        function connectToChannel() {
            if (client) {
                client.disconnect();
            }

            client = new Chat({});

            function addMessage(user, channel, msg, displayname, color) {
                const app = document.getElementById("twitchChat");

                let div = document.createElement("div");
                div.innerHTML = `<strong><span style="${color ? ('color: ' + color) : ''}">${displayname ? displayname : user}</span>:</strong> ${msg}`;
                app.appendChild(div);
            }

            function cleanMessage(message) {
                return cheerPrefixesRegExp.reduce(
                    (accumulator, prefix) => accumulator.replaceAll(prefix, ""),
                    message
                );
            }

            const run = async () => {
                client.on("*", (message) => {
                    console.log(JSON.stringify(message, null, 4));
                    const time = new Date(message.timestamp).toTimeString();
                    const event = message.event || message.command;
                    const channel = message.channel ? message.channel.substr(1) : undefined;
                    let msg = message.message || "";

                    if (!message.tags.username || !msg) {
                        return;
                    }

                    let isMod = message.tags.mod || message.tags.badges.broadcaster;

                    if (!message.tags.username || !msg) {
                        return;
                    }
                    let messageBits = message.bits || 0;
                    if (config.voice.bits && messageBits >= config.voice.bits.min) {
                        let voice = config.voice.bits[message.bits] || config.voice.bits.default;
                        let ttsItem = {
                            msg: cleanMessage(msg), 
                            user: message.tags.username, 
                            id: message.tags.id, 
                            voice: voice.id, 
                            similarity: voice.similarity,
                            stability: voice.stability,
                            style: voice.style
                        };
                        queue.push(ttsItem)
                        archive[ttsItem.id] = ttsItem;
                    }

                    if (isMod && msg.indexOf('replay') > -1) {
                        let refMsgId = message.tags.replyParentMsgId;
                        if (archive[refMsgId]) {
                            queue.push(archive[refMsgId]);
                        }
                    }

                    addMessage(message.tags.username, channel, msg, message.tags.displayName, message.tags.color);
                });

                await client.connect();
                await client.join(channelName);

                addMessage("AI TTS", undefined,  channelName + ' Connected');
            };

            run();
        }

        function checkQueue() {
            if (playing) return;

            if (index >= queue.length) return

            const item = queue[index++];

            if (!item) return;

            playing = true;
            playTTS(item.msg, 
                    item.voice, 
                    item.similarity || 0.8,
                    item.stability || 0.8,
                    item.style || 0.8,
                    null, 
                    () => {playing = false},
                    5000);
        }

        function getQueryVariable(query, variable) {
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');
                if (decodeURIComponent(pair[0]) == variable) {
                    return decodeURIComponent(pair[1]);
                }
            }
            console.log('Query variable %s not found', variable);
        }
    </script>
    <style>
        #twitchChat {
            overflow: scroll;
            padding: 0 5px;
            margin-top: 10px;
        }
        #twitchChat > div {
            padding: 1px 10px;
        }
        body.dark {
            background-color: #282828;
            color: #c6c6c6;
        }
    </style>
</head>
<body>
<div>
    <h1>Twitch AI TTS</h1>
</div>

<div id="twitchChat"></div>

<script>
    let dark = window.matchMedia("(prefers-color-scheme: dark)").matches;
    document.querySelector("body").className = dark ? "dark" : "";

    connectToChannel();

    setInterval(checkQueue, 1000)
</script>
</body>
</html>